<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenClaw Setup</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            surface: '#141414',
            border: '#222',
          }
        }
      }
    }
  </script>
  <style>
    .scope-btn { background: #1a1a1a; color: #555; border: 1px solid #333; transition: all 0.15s; }
    .scope-btn:hover { border-color: #555; }
    .scope-btn.active { background: #065f46; color: #6ee7b7; border-color: #059669; }
  </style>
</head>
<body class="bg-[#0a0a0a] text-gray-200 min-h-screen flex items-center justify-center p-4">
  <div class="max-w-lg w-full space-y-4">
    <!-- Header -->
    <div>
      <div class="text-4xl mb-1">üêæ</div>
      <h1 class="text-2xl font-semibold">OpenClaw</h1>
      <p class="text-gray-500 text-sm mt-1">Your agent is deploying. Complete setup below.</p>
    </div>

    <!-- Gateway Status -->
    <div class="bg-surface border border-border rounded-xl p-4">
      <div class="flex items-center gap-2">
        <span id="gatewayDot" class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></span>
        <span class="font-semibold">Gateway:</span>
        <span id="gatewayStatus" class="text-gray-400">checking...</span>
      </div>
    </div>

    <!-- Channels -->
    <div class="bg-surface border border-border rounded-xl p-4">
      <h2 class="font-semibold mb-3">Channels</h2>
      <div id="channels" class="space-y-2">
        <div class="text-gray-500 text-sm text-center py-2">Loading...</div>
      </div>
    </div>

    <!-- Pending Pairings -->
    <div class="bg-surface border border-border rounded-xl p-4">
      <h2 class="font-semibold mb-3">Pending Pairings</h2>
      <div id="pairings">
        <div class="text-gray-500 text-sm text-center py-2">No pending pairings</div>
      </div>
      <p class="text-gray-600 text-xs mt-3 leading-relaxed">
        Send any message to your bot on Telegram or Discord. The pairing request will appear here.
      </p>
    </div>

    <!-- Google Workspace -->
    <div class="bg-surface border border-border rounded-xl p-4">
      <h2 class="font-semibold mb-3">Google Workspace</h2>
      <div id="googleStatus">
        <div class="text-gray-500 text-sm text-center py-2">Loading...</div>
      </div>
    </div>

    <!-- Footer -->
    <p class="text-center text-gray-600 text-xs">
      Pairings auto-refresh every 15s ¬∑
      <a href="#" onclick="fullRefresh(); return false;" class="text-gray-500 hover:text-gray-300">Refresh all</a>
    </p>
  </div>

  <!-- Google Credentials Modal -->
  <div id="googleModal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-surface border border-border rounded-xl p-6 max-w-md w-full space-y-4">
      <h2 class="text-lg font-semibold">Connect Google Workspace</h2>
      <div class="space-y-3">
        <div>
          <p class="text-gray-400 text-sm mb-3">
            You'll need a Google Cloud OAuth app.
            <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-blue-400 hover:text-blue-300">Create one here ‚Üí</a>
          </p>
          <details class="text-xs text-gray-500 mb-3">
            <summary class="cursor-pointer hover:text-gray-300">Step-by-step instructions</summary>
            <div class="mt-2 mb-2 flex gap-2">
              <button onclick="showInstructions('workspace')" id="btnWorkspace" class="px-2 py-1 rounded bg-gray-800 text-gray-400 hover:text-gray-200 text-xs">Google Workspace</button>
              <button onclick="showInstructions('personal')" id="btnPersonal" class="px-2 py-1 rounded bg-gray-700 text-gray-200 text-xs">Personal Gmail</button>
            </div>
            <div id="instructionsPersonal">
              <ol class="list-decimal list-inside space-y-1.5 ml-1">
                <li><a href="https://console.cloud.google.com/projectcreate" target="_blank" class="text-blue-400 hover:text-blue-300">Create a Google Cloud project</a> (or use existing)</li>
                <li>Go to <a href="https://console.cloud.google.com/auth/audience" target="_blank" class="text-blue-400 hover:text-blue-300">OAuth consent screen</a> ‚Üí set to <strong>External</strong></li>
                <li>Under <a href="https://console.cloud.google.com/auth/audience" target="_blank" class="text-blue-400 hover:text-blue-300">Test users</a>, <strong>add your own email</strong></li>
                <li><a href="https://console.cloud.google.com/apis/library" target="_blank" class="text-blue-400 hover:text-blue-300">Enable APIs</a> for the services you selected below</li>
                <li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-blue-400 hover:text-blue-300">Credentials</a> ‚Üí Create OAuth 2.0 Client ID (Web application)</li>
                <li>Add redirect URI: <code id="redirectUri" class="bg-black/40 px-1 rounded text-gray-400"></code></li>
                <li>Copy Client ID + Secret (or download credentials JSON)</li>
              </ol>
              <p class="mt-2 text-yellow-500/80">‚ö†Ô∏è App will be in "Testing" mode. Only emails added as Test Users can sign in (up to 100).</p>
            </div>
            <div id="instructionsWorkspace" class="hidden">
              <ol class="list-decimal list-inside space-y-1.5 ml-1">
                <li><a href="https://console.cloud.google.com/projectcreate" target="_blank" class="text-blue-400 hover:text-blue-300">Create a Google Cloud project</a> (or use existing)</li>
                <li>Go to <a href="https://console.cloud.google.com/auth/audience" target="_blank" class="text-blue-400 hover:text-blue-300">OAuth consent screen</a> ‚Üí set to <strong>Internal</strong> (Workspace only)</li>
                <li><a href="https://console.cloud.google.com/apis/library" target="_blank" class="text-blue-400 hover:text-blue-300">Enable APIs</a> for the services you selected below</li>
                <li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-blue-400 hover:text-blue-300">Credentials</a> ‚Üí Create OAuth 2.0 Client ID (Web application)</li>
                <li>Add redirect URI: <code id="redirectUriWs" class="bg-black/40 px-1 rounded text-gray-400"></code></li>
                <li>Copy Client ID + Secret (or download credentials JSON)</li>
              </ol>
              <p class="mt-2 text-green-500/80">‚úì Internal apps skip test users and verification. Any user in your org can sign in.</p>
            </div>
          </details>
        </div>
        <div>
          <label class="text-sm text-gray-400 block mb-1">Upload credentials.json</label>
          <input type="file" id="credentialsFile" accept=".json"
            class="w-full text-sm text-gray-400 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-gray-800 file:text-gray-300 hover:file:bg-gray-700" />
        </div>
        <div class="text-gray-500 text-xs text-center">‚Äî or enter manually ‚Äî</div>
        <div>
          <label class="text-sm text-gray-400 block mb-1">Client ID</label>
          <input type="text" id="clientId" placeholder="xxxx.apps.googleusercontent.com"
            class="w-full bg-black/40 border border-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-gray-500" />
        </div>
        <div>
          <label class="text-sm text-gray-400 block mb-1">Client Secret</label>
          <input type="password" id="clientSecret" placeholder="GOCSPX-..."
            class="w-full bg-black/40 border border-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-gray-500" />
        </div>
        <div>
          <label class="text-sm text-gray-400 block mb-1">Email (Google account to authorize)</label>
          <input type="email" id="googleEmail" placeholder="you@gmail.com"
            class="w-full bg-black/40 border border-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-gray-500" />
        </div>
      </div>
      <div class="flex gap-2 pt-2">
        <button onclick="submitGoogleCredentials()" id="googleSubmitBtn"
          class="flex-1 bg-green-500 text-black font-medium py-2 rounded-lg hover:opacity-85 transition-opacity text-sm">
          Connect Google
        </button>
        <button onclick="closeGoogleModal()"
          class="px-4 bg-gray-800 text-gray-300 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm">
          Cancel
        </button>
      </div>
      <div id="googleError" class="text-red-400 text-xs hidden"></div>
    </div>
  </div>

  <script>
    // ============================================================
    // Scope picker
    // ============================================================
    const SERVICES = [
      { key: 'gmail', icon: 'üìß', label: 'Gmail', defaultRead: true, defaultWrite: true },
      { key: 'calendar', icon: 'üìÖ', label: 'Calendar', defaultRead: true, defaultWrite: true },
      { key: 'drive', icon: 'üìÅ', label: 'Drive', defaultRead: false, defaultWrite: false },
      { key: 'contacts', icon: 'üë§', label: 'Contacts', defaultRead: false, defaultWrite: false },
      { key: 'sheets', icon: 'üìä', label: 'Sheets', defaultRead: false, defaultWrite: false },
    ];

    let lastGoogleScopes = [];
    let lastApiStatus = {}; // cached API check results

    function toggleScope(btn, scope) {
      btn.classList.toggle('active');
      if (scope.endsWith(':write') && btn.classList.contains('active')) {
        const readBtn = document.querySelector(`[data-scope="${scope.replace(':write', ':read')}"]`);
        if (readBtn) readBtn.classList.add('active');
      }
      if (scope.endsWith(':read') && !btn.classList.contains('active')) {
        const writeBtn = document.querySelector(`[data-scope="${scope.replace(':read', ':write')}"]`);
        if (writeBtn) writeBtn.classList.remove('active');
      }
    }

    function getSelectedScopes() {
      const container = document.getElementById('inlineScopePicker');
      if (!container) return [];
      return Array.from(container.querySelectorAll('.scope-btn.active')).map(b => b.dataset.scope);
    }

    function renderScopePicker(containerId, activeScopes, apiStatus) {
      const el = document.getElementById(containerId);
      const hasActive = activeScopes && activeScopes.length > 0;
      const status = apiStatus || lastApiStatus;

      el.innerHTML = SERVICES.map(s => {
        const readOn = hasActive ? activeScopes.includes(`${s.key}:read`) : s.defaultRead;
        const writeOn = hasActive ? activeScopes.includes(`${s.key}:write`) : s.defaultWrite;
        const api = status[s.key];
        let apiIndicator = '';
        if (api) {
          if (api.status === 'ok') {
            apiIndicator = '<span class="text-green-500 text-xs">‚úì API</span>';
          } else if (api.status === 'not_enabled') {
            apiIndicator = `<a href="${api.enableUrl}" target="_blank" class="text-red-400 hover:text-red-300 text-xs">‚úó API</a>`;
          } else if (api.status === 'error') {
            apiIndicator = '<span class="text-yellow-500 text-xs">? API</span>';
          }
        }

        return `
        <div class="flex items-center justify-between bg-black/30 rounded-lg px-3 py-2">
          <span class="text-sm">${s.icon} ${s.label}</span>
          <div class="flex items-center gap-2">
            ${apiIndicator}
            <button onclick="toggleScope(this,'${s.key}:read')" data-scope="${s.key}:read" class="scope-btn ${readOn ? 'active' : ''} text-xs px-2 py-0.5 rounded">Read</button>
            <button onclick="toggleScope(this,'${s.key}:write')" data-scope="${s.key}:write" class="scope-btn ${writeOn ? 'active' : ''} text-xs px-2 py-0.5 rounded">Write</button>
          </div>
        </div>`;
      }).join('');
    }

    // ============================================================
    // Google OAuth
    // ============================================================
    function startGoogleAuth(email) {
      const scopes = getSelectedScopes();
      if (scopes.length === 0) { alert('Select at least one service'); return; }
      const authUrl = `/auth/google/start?email=${encodeURIComponent(email)}&services=${scopes.join(',')}`;
      const popup = window.open(authUrl, 'google-auth', 'popup=yes,width=500,height=700');
      if (!popup || popup.closed) window.location.href = authUrl;
    }

    window.addEventListener('message', (e) => {
      if (e.data?.google === 'success') {
        showToast('‚úì Google account connected', 'green');
        fullRefresh();
      } else if (e.data?.google === 'error') {
        showToast('‚úó Google auth failed: ' + (e.data.message || 'unknown'), 'red');
      }
    });

    function showToast(text, color) {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 bg-${color}-500/20 border border-${color}-500/30 text-${color}-400 px-4 py-2 rounded-lg text-sm z-50`;
      toast.textContent = text;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    async function checkGoogleApis(refreshPicker) {
      const res = await fetch('/api/google/check');
      const data = await res.json();
      if (data.results) {
        lastApiStatus = data.results;
        if (refreshPicker) {
          renderScopePicker('inlineScopePicker', lastGoogleScopes, lastApiStatus);
        }
      }
      return data;
    }

    async function disconnectGoogle() {
      if (!confirm('Disconnect Google account? Your agent will lose access to Gmail, Calendar, etc.')) return;
      const res = await fetch('/api/google/disconnect', { method: 'POST' });
      const data = await res.json();
      if (data.ok) fullRefresh();
      else alert('Failed to disconnect: ' + (data.error || 'unknown'));
    }

    // ============================================================
    // Google UI rendering
    // ============================================================
    let lastGoogleState = null;

    function renderGoogleUI(google) {
      lastGoogleState = google;
      const googleEl = document.getElementById('googleStatus');
      if (google.activeScopes) lastGoogleScopes = google.activeScopes;

      if (google.authenticated || google.hasCredentials) {
        const email = google.email || '';
        const isAuthed = google.authenticated;

        googleEl.innerHTML = `
          <div class="space-y-3">
            ${isAuthed ? `
              <div class="flex justify-between items-center">
                <div class="text-sm font-medium">${email}</div>
                <span class="text-xs px-2 py-0.5 rounded-full font-medium bg-green-500/10 text-green-500">Connected</span>
              </div>
            ` : `
              <div class="text-sm text-gray-400">OAuth app configured for <strong>${email}</strong></div>
            `}
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-400">Select permissions</span>
              <button onclick="checkGoogleApis(true)" class="text-xs text-gray-500 hover:text-gray-300">‚Üª Check APIs</button>
            </div>
            <div id="inlineScopePicker" class="space-y-2"></div>
            <div class="flex justify-between items-center pt-1">
              <button onclick="startGoogleAuth('${email}')" class="bg-white text-black text-sm font-medium px-4 py-2 rounded-lg hover:opacity-85">
                ${isAuthed ? 'Update Permissions' : 'Sign in with Google'}
              </button>
              <button onclick="disconnectGoogle()" class="text-xs text-red-400/60 hover:text-red-400">Disconnect</button>
            </div>
          </div>`;

        renderScopePicker('inlineScopePicker', google.activeScopes || [], lastApiStatus);

        // Auto-check APIs on load if authenticated
        if (isAuthed && Object.keys(lastApiStatus).length === 0) {
          checkGoogleApis(true);
        }
      } else {
        googleEl.innerHTML = `
          <div class="text-center space-y-2 py-1">
            <p class="text-sm text-gray-400">Connect Gmail, Calendar, and Drive to your agent.</p>
            <button onclick="openGoogleModal()" class="bg-white text-black text-sm font-medium px-4 py-2 rounded-lg hover:opacity-85">Set up Google</button>
          </div>`;
      }
    }

    // ============================================================
    // Refresh logic
    // ============================================================
    async function refreshPairings() {
      try {
        const statusRes = await fetch('/api/status');
        const status = await statusRes.json();

        // Gateway
        const dot = document.getElementById('gatewayDot');
        const label = document.getElementById('gatewayStatus');
        if (status.gateway === 'running') {
          dot.className = 'w-2 h-2 rounded-full bg-green-500';
          label.textContent = 'running';
        } else {
          dot.className = 'w-2 h-2 rounded-full bg-yellow-500 animate-pulse';
          label.textContent = status.gateway;
        }

        // Channels
        const channelsEl = document.getElementById('channels');
        const allChannels = ['telegram', 'discord'];
        channelsEl.innerHTML = allChannels.map(ch => {
          const info = status.channels?.[ch];
          let badgeClass, badgeText;
          if (!info) {
            badgeClass = 'bg-gray-800 text-gray-500';
            badgeText = 'Not configured';
          } else if (info.status === 'paired') {
            badgeClass = 'bg-green-500/10 text-green-500';
            badgeText = `Paired (${info.paired})`;
          } else {
            badgeClass = 'bg-yellow-500/10 text-yellow-500';
            badgeText = 'Awaiting pairing';
          }
          return `<div class="flex justify-between items-center py-1.5">
            <span class="font-medium text-sm">${ch.charAt(0).toUpperCase() + ch.slice(1)}</span>
            <span class="text-xs px-2 py-0.5 rounded-full font-medium ${badgeClass}">${badgeText}</span>
          </div>`;
        }).join('');

        // Pairings only
        const pairingsEl = document.getElementById('pairings');
        if (status.gateway === 'running') {
          const pairRes = await fetch('/api/pairings');
          const pairData = await pairRes.json();
          const pending = pairData.pending || [];
          if (pending.length === 0) {
            pairingsEl.innerHTML = '<div class="text-gray-500 text-sm text-center py-2">No pending pairings</div>';
          } else {
            pairingsEl.innerHTML = pending.map(p => `
              <div class="bg-black/30 rounded-lg p-3 mb-2">
                <div class="font-medium text-sm mb-2">${(p.channel || 'unknown').charAt(0).toUpperCase() + (p.channel || '').slice(1)} ¬∑ <code class="text-gray-400">${p.code || p.id || '?'}</code></div>
                <div class="flex gap-2">
                  <button onclick="approve('${p.id}', '${p.channel}')" class="bg-green-500 text-black text-xs font-medium px-3 py-1.5 rounded-lg hover:opacity-85">Approve</button>
                  <button onclick="reject('${p.id}', '${p.channel}')" class="bg-gray-800 text-gray-300 text-xs px-3 py-1.5 rounded-lg hover:bg-gray-700">Reject</button>
                </div>
              </div>
            `).join('');
          }
        }
      } catch (err) {
        console.error('Refresh failed:', err);
      }
    }

    async function fullRefresh() {
      await refreshPairings();

      // Google (only on full refresh)
      try {
        const googleRes = await fetch('/api/google/status');
        const google = await googleRes.json();
        renderGoogleUI(google);
      } catch {}
    }

    async function approve(id, channel) {
      await fetch(`/api/pairings/${id}/approve`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ channel }),
      });
      setTimeout(refreshPairings, 500);
    }

    async function reject(id, channel) {
      await fetch(`/api/pairings/${id}/reject`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ channel }),
      });
      setTimeout(refreshPairings, 500);
    }

    // ============================================================
    // Modal
    // ============================================================
    function openGoogleModal() {
      document.getElementById('googleModal').classList.remove('hidden');
    }

    function closeGoogleModal() {
      document.getElementById('googleModal').classList.add('hidden');
      document.getElementById('googleError').classList.add('hidden');
    }

    function showInstructions(type) {
      document.getElementById('instructionsPersonal').classList.toggle('hidden', type !== 'personal');
      document.getElementById('instructionsWorkspace').classList.toggle('hidden', type !== 'workspace');
      document.getElementById('btnPersonal').className = `px-2 py-1 rounded text-xs ${type === 'personal' ? 'bg-gray-700 text-gray-200' : 'bg-gray-800 text-gray-400 hover:text-gray-200'}`;
      document.getElementById('btnWorkspace').className = `px-2 py-1 rounded text-xs ${type === 'workspace' ? 'bg-gray-700 text-gray-200' : 'bg-gray-800 text-gray-400 hover:text-gray-200'}`;
    }

    document.getElementById('credentialsFile').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const json = JSON.parse(text);
        const creds = json.installed || json.web || json;
        if (creds.client_id) document.getElementById('clientId').value = creds.client_id;
        if (creds.client_secret) document.getElementById('clientSecret').value = creds.client_secret;
      } catch (err) {
        document.getElementById('googleError').textContent = 'Invalid JSON file';
        document.getElementById('googleError').classList.remove('hidden');
      }
    });

    async function submitGoogleCredentials() {
      const btn = document.getElementById('googleSubmitBtn');
      const errorEl = document.getElementById('googleError');
      errorEl.classList.add('hidden');

      const clientId = document.getElementById('clientId').value.trim();
      const clientSecret = document.getElementById('clientSecret').value.trim();
      const email = document.getElementById('googleEmail').value.trim();

      if (!clientId || !clientSecret || !email) {
        errorEl.textContent = 'All fields required';
        errorEl.classList.remove('hidden');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        const res = await fetch('/api/google/credentials', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ clientId, clientSecret, email }),
        });
        const data = await res.json();
        if (data.ok) {
          closeGoogleModal();
          fullRefresh();
        } else {
          errorEl.textContent = data.error || 'Failed to save credentials';
          errorEl.classList.remove('hidden');
        }
      } catch (err) {
        errorEl.textContent = 'Request failed';
        errorEl.classList.remove('hidden');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Connect Google';
      }
    }

    // ============================================================
    // Init
    // ============================================================
    const rUri = `${window.location.origin}/auth/google/callback`;
    document.getElementById('redirectUri').textContent = rUri;
    document.getElementById('redirectUriWs').textContent = rUri;

    fullRefresh();
    setInterval(refreshPairings, 15000);
  </script>
</body>
</html>
